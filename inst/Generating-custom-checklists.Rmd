---
title: "Custom checklists using rWCVP"
author: "Matilda Brown"
date: "24/05/2022"
output: 
  html_document: 
    highlight: haddock
    theme: sandstone
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
```

Here, I demonstrate how we can modify our checklist output to generate a customised report. The objective for this example is: **to generate a list of species that are endemic (or near-endemic) to Sierra Leone**. 

In this example I use the pipe operator (`%>%`),`dplyr` and `ggplot` - if these are unfamiliar I'd suggest checking out https://tidyverse.org/ and some of the help pages therein, or this code might be difficult to interpret.
Now, let's get started! 


```{r message=FALSE}
#load in some packages
library(rWCVP)
library(tidyverse) # for data manipulation
library(gt) # for tables
```



### Endemic species

It makes sense to look at endemic species before we expand our scope to include near-endemics.  

We start by generating a checklist of the species that occur in Sierra Leone. Remembering and/or finding the appropriate WGSRPD Level 3 codes is a pain, so we can use `get_wgsrpd3_codes("Sierra Leone")` to do that work for us in the function call. 

```{r}
sl_species <- generate_checklist(area = get_wgsrpd3_codes("Sierra Leone"), synonyms = FALSE)
```
How many species occur in Sierra Leone, and how many are endemic? We can use the `endemic` column here, so it's really simple:
```{r}
#enclosed in parentheses so that the output is printed as well as assigned
(endemic_summary <- sl_species %>% 
  select(taxon_name, endemic) %>% 
  unique() %>% 
  group_by(endemic) %>% 
  summarise(number.of.sp = n()))
```
Easy! For a list of endemic species, we could simply filter our checklist using the `endemic` column, but what about **near-endemics**?

### Near-endemic species

Depending on how we define near-endemics, there are two ways we can approach the filtering step. 

1. We define near-endemics as those species that occur in Sierra Leone + one other WGSPRD3 Area (L3). From a data perspective, this means filtering out species that have >2 rows in `sl_species` (because each row is a species-area occurrence). 
2. Alternatively, we can consider near-endemics as those species that might occur across a border, so are functionally endemic. To do this, we need to a) identify the neighbouring WGSPRD3 Areas and b) filter our species list accordingly. 

Let's start with Option 1. 

```{r}
#get the list of near-endemics
near_endemics <- sl_species %>% 
  select(plant_name_id, taxon_name, area_code_l3) %>% #not strictly necessary 
  unique() %>% 
  group_by(plant_name_id, taxon_name) %>% 
  summarise(number.of.areas = n()) %>% 
  filter(number.of.areas < 3) 

#filter sl_species according to that list
sl_nearendemics1 <- sl_species %>% 
  filter(plant_name_id %in% near_endemics$plant_name_id) 

```

Once we have our checklist filtered to near-endemics, the formatting is the same regardless of which option we choose, so let's also look at option 2 while we're in the filtering stage. 

First, we need to identify which WGSRPD Areas share a border with Sierra Leone. We can do this by looking at a map, but for completeness, we can also do it using the spatial polygons in the `rWCVPdata` package:
```{r message=FALSE}
library(spdep)
#get the polygons for WGSRPD Level 3 Areas
area_polygons <- rWCVPdata::wgsprd3 
sf_use_s2(FALSE) #switch off spherical geometry - necessary for these polygons

#which polygon/s is/are Sierra Leone? 
sl_index <- which(area_polygons$LEVEL3_COD %in% get_wgsrpd3_codes("Sierra Leone"))

#find neighbouring polygons
sl_neighbours_index <- poly2nb(area_polygons)[[sl_index]]

#get the polygons for Sierra Leone plus its neighbours
sl_plus_neighbours <- area_polygons[c(sl_index, sl_neighbours_index),]

#get the Area codes of SL + neighbours to use in filtering
sl_plus_neighbours_codes <- sl_plus_neighbours$LEVEL3_COD

```
This is all very well and good, but it would be nice to sanity-check this automated neighbour detection before we generate our final checklist. Let's make a map of the region to make sure we've selected the right areas:

```{r}
#get a sensible bounding box for our plot
bounding_box <- st_bbox(sl_plus_neighbours)
xmin <- bounding_box["xmin"] - 2
xmax <- bounding_box["xmax"] + 2
ymin <- bounding_box["ymin"] - 2
ymax <- bounding_box["ymax"] + 2

#plot the map
ggplot(area_polygons) + 
  #world polygons first, for context
  geom_sf(fill="white", colour="grey") + 
  #add polygons of interest
  geom_sf(data=sl_plus_neighbours, fill="#a4dba2", colour="gray20")+ 
  #bounding box we sey up above
  coord_sf(xlim=c(xmin, xmax), ylim=c(ymin, ymax))+
  #add country name labels
  geom_sf_label(data=sl_plus_neighbours,aes(label=sl_plus_neighbours$LEVEL3_NAM))+
  #add ocean background
  theme(panel.background = element_rect(fill="#b6badb")) +
  #remove x and y from axes
  xlab(NULL) +
  ylab(NULL)
```
<br> Looks good! Let's just check that our area codes match up:
```{r}
wgsrpd_mapping %>% filter(LEVEL3_COD %in% sl_plus_neighbours_codes)
```
They match! Of course, we could have just identified Guinea and Liberia as neighbouring countries from a map, then found the codes using `get_wgsrpd3_codes("Liberia")` and `get_wgsrpd3_codes("Guinea")`, but that's not nearly as much fun!
<br>
Now we can identify near-endemics as those species that *only* have occurrences in Sierra Leone, Guinea or Liberia. 


```{r}
sl_nearendemics2 <- sl_species %>% 
  #filter to only species that are not in the list of...
  filter(!plant_name_id %in% 
           # ...species that have occurrences outside SL+Neighbours
           # i.e., the non-near-endemics
           (sl_species %>% 
           filter(!area_code_l3 %in% sl_plus_neighbours_codes) %>% 
           pull(plant_name_id))
  )
```

Now, we do the same thing as before (Option 1), filtering our list to only species that occur in Sierra Leone + one neighbour. Looking at the map it seems plausible that a species could occur right at the triple junction between the three countries, but for this example we will exclude those species. 

```{r}
#get the list of near-endemics that only occur in SL + one neighbour
near_endemics <- sl_nearendemics2 %>% 
  select(plant_name_id, taxon_name, area_code_l3) %>% #not strictly necessary 
  unique() %>% 
  group_by(plant_name_id, taxon_name) %>% 
  summarise(number.of.areas = n()) %>% 
  filter(number.of.areas < 3) 

#filter sl_nearendemics2 according to that list
sl_nearendemics2 <- sl_nearendemics2 %>% 
  filter(plant_name_id %in% near_endemics$plant_name_id) 


```

The next part is a bit fancy - we want to turn out checklist dataframe into a formatted report. To do this, we plug it into a template file called "custom_checklist.Rmd" that is stored in the `rWCVP` package folder (specifically, the "rmd" subfolder). We pass the data (as well as some other information) using `params`, and need to specify a filename using `output_file`. 


```{r eval=FALSE}
library(rmarkdown)

#informative test to include in our html
checklist_description <- "Checklist of species that are endemic to Sierra Leone (or near-endemic, based on neighbouring countries)"

#for file saving
wd <- getwd()

#do the rendering
render(system.file("rmd", "custom_checklist.Rmd", package = "rWCVP"),
                      quiet = TRUE,
                      params=list( version = "New Phytologist Special Issue",
                                   mydata = sl_nearendemics2,
                                   description = checklist_description),
       output_file = paste0(wd,"/Sierra_Leone_endemics_and_near_endemics.html"))


```

And here is our file (screenshot here, because the report has left the building)! 

____

![example report](Custom-checklist_example_report.png)
