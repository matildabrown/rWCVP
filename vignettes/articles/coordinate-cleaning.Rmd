---
title: "Cleaning coordinates to native range with rWCVP"
author: "Matilda Brown"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  warning = FALSE
  comment = "#>"
)
```


Load in some packages:

```{r}
library(rWCVP)
library(rgbif)
library(tidyverse)
library(sf)
```

For an example, we're using *Callitris rhomboidea*, a lovely Australian conifer. First, we download the occurrences using the `rgbif` package.
Non-GBIF data with latitude and longitude coordinates still need to be converted to spatial points using `st_as_sf(coords = c(long, lat)` and the appropriate coordinate reference system (`st_crs(4326)` is the CRS for WGS84, used for GPS coordinates).

```{r}
occs_0 <- rgbif::occ_data(scientificName = "Callitris rhomboidea", limit = 1000)
occs <- occs_0$data %>% 
  select(scientificName, decimalLatitude, decimalLongitude) %>% #only want name and coords
  na.omit() %>% #delete missing coords
  st_as_sf(coords=c(3,2),crs = st_crs(4326)) #make the points spatial 
```

We would probably want to do some other filtering, but let's skip that for now, and move on to the native ranges: 

```{r}
d_all <- get_distribution("Callitris rhomboidea", rank="species")


# Plot_distribution gives you two plots, one with a full world map and one with 
# a zoomed in field of view
plot_distribution(d_all, crop.map = TRUE)

```


We're only really interested in the native distribution...

```{r}
d_native <- get_distribution("Callitris rhomboidea", rank="species", 
                             introduced = FALSE, extinct = FALSE, 
                             location_doubtful = FALSE)

p <- plot_distribution(d_native, crop.map = TRUE)
(p <- p + theme(legend.position = "none"))
```

Now, how do our points map onto the range? 

```{r}
p + geom_sf(data=occs, fill="#6e6ad9",col="black", shape=21) 
```

Yikes, let's get rid of those rogue points. First, get TRUE/FALSE values for whether each point falls within the native range polygon, and plot them coloured by this value:

```{r}
occs$native <- factor(sf::st_intersects(occs, st_union(d_native), sparse=FALSE))

p+
  geom_sf(data=occs, 
          fill=c("red","#72994c")[occs$native],
          col="black", 
          shape=21)
```


Let's have a closer look at the ones that are near the green:
```{r}
lims <- st_bbox(d_native) #getting a sensible bounding box
p +
  geom_sf(data=occs, 
          fill=c("red","#72994c")[occs$native],
          col="black", 
          shape=21)+
  coord_sf(xlim=lims[c(1,3)], ylim=lims[c(2,4)])
```

    
        
Ah, they are in the water! Note: the WGSRPD shapefiles that we are using as a base map are not super-high resolution, so it might be worth adding a buffer so that we are not cleaning too enthusiastically. 

The coordinates for the shapefile are in degrees, so a 1km buffer is approximately 0.009 degrees latitude (and longitude at the equator). For high latitudes, a buffer of 0.009 degrees is going to be significantly more than a kilometre, but the important thing is that points won't be removed because of minor differences in the shapefile. 

Let's see which of our occurrences fall within ~1km of the native range. For clarity, we've removed the points that are within the native range and are just plotting the points that are within the buffer (yellow) and those that are outside the buffer (red). 
```{r}
occs$native_buffer <- factor(sf::st_intersects(occs, st_buffer(st_union(d_native), 0.009), sparse=FALSE))

#filter out the points that are in the native range
occs2 <- occs %>% filter(native == FALSE)

p+geom_sf(data = st_buffer(st_union(d_native), 0.009), fill="transparent", col="gold")+
  geom_sf(data=occs2, 
          fill=c("red","gold")[occs2$native_buffer],
          col="black", 
          shape=21)+
    coord_sf(xlim=lims[c(1,3)], ylim=lims[c(2,4)])
```
    
An appropriate buffer width might be wider or narrower, depending on downstream analyses but we strongly suggest visualisation to sanity-check the buffer before using it to discard points. 

Now, we can discard occurrences that are >1km (approximately) outside of the native range and plot them one last time, just to make sure it's worked:
```{r}
occs_filtered <- occs %>% filter(native_buffer == TRUE)

#filtered occurrences plotted
p +
  geom_sf(data=occs_filtered, fill="#6e6ad9",col="black", shape=21)
```


