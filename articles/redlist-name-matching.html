<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rWCVP">
<title>Matching names to WCVP with rWCVP • rWCVP</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Matching names to WCVP with rWCVP">
<meta property="og:description" content="rWCVP">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rWCVP</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/rWCVP.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/coordinate-cleaning.html">Cleaning coordinates to species' native range with rWCVP</a>
    <a class="dropdown-item" href="../articles/custom-checklist.html">Generating custom checklists with rWCVP</a>
    <a class="dropdown-item" href="../articles/mapping-diversity.html">Mapping diversity with rWCVP</a>
    <a class="dropdown-item" href="../articles/occurrence-matrices.html">Publication-ready occurrence matrices with rWCVP</a>
    <a class="dropdown-item" href="../articles/redlist-name-matching.html">Matching names to WCVP with rWCVP</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/matildabrown/rWCVP/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Matching names to WCVP with rWCVP</h1>
                        <h4 data-toc-skip class="author">Matilda
Brown</h4>
            
            <h4 data-toc-skip class="date">2023-02-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/matildabrown/rWCVP/blob/HEAD/vignettes/articles/redlist-name-matching.Rmd" class="external-link"><code>vignettes/articles/redlist-name-matching.Rmd</code></a></small>
      <div class="d-none name"><code>redlist-name-matching.Rmd</code></div>
    </div>

    
    
<!-- GENERATED BY vignettes/articles/precompile.R -->
<p>The World Checklist of Vascular Plants provides a global consensus
view of all known vascular plant species, including taxonomic status and
synonymy. As such, it can be used for standardising and reconciling
lists of plant names from other sources.</p>
<p>We have implemented name matching functions in rWCVP to make it
simpler for a user to standardise a list of plant names against
WCVP.</p>
<p>In this article, we’ll show you an example of how name matching in
rWCVP might fit into a realistic workflow.</p>
<p>As well as <code>rWCVP</code>, we’ll be using the
<code>tidyverse</code> collection of packages for data manipulation,
<code>gt</code> for formatting tables, and <code>ggalluvial</code> for
visualising the matching process.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/matildabrown/rWCVP" class="external-link">rWCVP</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com/" class="external-link">gt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://corybrunson.github.io/ggalluvial/" class="external-link">ggalluvial</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="example-dataset-the-iucn-red-list">Example dataset: the IUCN Red List<a class="anchor" aria-label="anchor" href="#example-dataset-the-iucn-red-list"></a>
</h2>
<p>The example we’ll use here is matching assessments from the IUCN Red
List of Threatened Species (Red List) to accepted names in the WCVP.</p>
<p>We’re using a download of plant assessments from version 2022-1 of
the Red List, which we made through <a href="https://www.iucnredlist.org/" class="external-link">their website</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">redlist</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span></span>
<span>  <span class="st">"../../inst/extdata/redlist-summary_2022-1.csv"</span>,</span>
<span>  col_types<span class="op">=</span><span class="fu">cols</span><span class="op">(</span>.default<span class="op">=</span><span class="fu">col_character</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">glimpse</span><span class="op">(</span><span class="va">redlist</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 61,015</span></span>
<span><span class="co">#&gt; Columns: 3</span></span>
<span><span class="co">#&gt; $ scientific_name &lt;chr&gt; "Cotoneaster granatensis", "Juniperus drupacea", "Picea omorika",~</span></span>
<span><span class="co">#&gt; $ authority       &lt;chr&gt; "Boiss.", "Labill.", "(Pancic) Purk.", "Boiss.", "Steud. &amp;amp; Ho~</span></span>
<span><span class="co">#&gt; $ category        &lt;chr&gt; "LR/cd", "LC", "EN", "VU", "LC", "EN", "VU", "LC", "EN", "CR", "N~</span></span></code></pre></div>
<p>Now that we’ve loaded the names from the Red List, we can match them
to the WCVP using the <code>wcvp_match_names</code> function.</p>
<p>This function takes a data frame of names for matching, the name of
the column in the data frame storing the names, and (optionally) the
name of the column storing the authors for each name, if you want to
include that in the matching process.</p>
<p>The function will first try to find any names that match exactly to
names in the WCVP. If an author column has been provided, this first
step will include authors and a second step will run to match any
remaining names exactly without the author strings. All remaining
unmatched names are then passed through a fuzzy matching process that
tries to match names phonetically and then finds the most similar name
by Levenshtein distance.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>matches <span class="ot">&lt;-</span> <span class="fu">wcvp_match_names</span>(redlist,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">name_col=</span><span class="st">"scientific_name"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">author_col=</span><span class="st">"authority"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fuzzy=</span><span class="cn">TRUE</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">progress_bar=</span><span class="cn">FALSE</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -- Matching names to WCVP ---------------------------------</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; i Using the `scientific_name` column</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -- Exact matching 61015 names --</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; v Found 60165 of 61015 names</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; -- Fuzzy matching 850 names --</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>v Found <span class="dv">826</span> of <span class="dv">850</span> names</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="sc">--</span> Matching complete<span class="sc">!</span> <span class="sc">--</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>v Matched <span class="dv">60928</span> of <span class="dv">61015</span> names</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>i <span class="fu">Exact</span> (with author)<span class="sc">:</span> <span class="dv">43268</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>i <span class="fu">Exact</span> (without author)<span class="sc">:</span> <span class="dv">16897</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>i <span class="fu">Fuzzy</span> (edit distance)<span class="sc">:</span> <span class="dv">398</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>i <span class="fu">Fuzzy</span> (phonetic)<span class="sc">:</span> <span class="dv">365</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="sc">!</span> Names with multiple matches<span class="sc">:</span> <span class="dv">391</span></span></code></pre></div>
<p>We haven’t explicitly passed in a data frame of names from WCVP, and
we get a warning because we are using an out of date version via the
rWCVPdata package. We can ignore this warning for now because the
package (and therefore this tutorial) have been developed using a
version of the data that is not currently on the website.</p>
<p>We also get a series of messages, giving us an idea of the proportion
that were exact matched, and how long we can expect fuzzy matching to
take.</p>
<p>Once it’s finished, we get a full summary of how many names were
matched, how many used fuzzy matching, and how many were matched to
multiple names in the WCVP.</p>
<p>The output of the <code>wcvp_match_names</code> is a data frame of
our original names, which names they match to in the WCVP, and
information on how they were matched and how close any fuzzy matches
are.</p>
</div>
<div class="section level2">
<h2 id="resolving-matched-names-to-accepted-species">Resolving matched names to accepted species<a class="anchor" aria-label="anchor" href="#resolving-matched-names-to-accepted-species"></a>
</h2>
<p>Now we’ve matched our names, we can resolve the fuzzy matches and the
names that were matched to multiple entries in WCVP, and make sure our
assessed species are linked to accepted names in WCVP.</p>
<p>How you choose which fuzzy matches are valid and resolve multiple
matches will ultimately depend on your reason for doing the matching.
For instance, we’re matching IUCN assessments to accepted names in WCVP.
For this application, an assessment is only valid for a particular
taxonomic concept, so we might not care about resolving anything matched
to a non-homotypic synonym.</p>
<p>In the case of this tutorial, we’ve tried to resolve as many fuzzy
and multiple matches as possible first, before filtering out matches
that aren’t appropriate for our application.</p>
<div class="section level3">
<h3 id="fuzzy-matches">Fuzzy matches<a class="anchor" aria-label="anchor" href="#fuzzy-matches"></a>
</h3>
<p>There are not too many fuzzy matches (around 1000) but still a lot to
manually verify, so let’s do a bit of pre-checking based on the
following rules:</p>
<ol style="list-style-type: decimal">
<li>We want to manually verify anything that is &lt;90% similar.</li>
<li>If the fuzzy match has an identical author string and is ≥90%
similar, we keep it.</li>
<li>If the fuzzy match is only one letter out (i.e. has an edit distance
of 1) and is ≥90% similar, we keep it.</li>
</ol>
<p>Let’s apply these.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fuzzy_matches</span> <span class="op">&lt;-</span> <span class="va">matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">match_type</span>, <span class="st">"Fuzzy"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    keep <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span> <span class="co">#set up a keep column</span></span>
<span>      <span class="va">match_similarity</span> <span class="op">&lt;</span> <span class="fl">0.9</span> <span class="op">~</span> <span class="cn">NA_real_</span>, <span class="co"># fill with blank for dissimilar names</span></span>
<span>      <span class="va">wcvp_author_edit_distance</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">1</span>, <span class="co"># fill with 1 if authors identical</span></span>
<span>      <span class="va">match_edit_distance</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="fl">1</span>, <span class="co"># fill with 1 if only one letter different</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#how many did this resolve?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">fuzzy_matches</span><span class="op">$</span><span class="va">keep</span>, useNA <span class="op">=</span> <span class="st">"always"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    1 &lt;NA&gt; </span></span>
<span><span class="co">#&gt;  534  317</span></span></code></pre></div>
<p>A great start! Over half of all fuzzy matches can be resolved without
looking at them.</p>
<p>What about an edit distance of 2 - surely that’s still pretty
close?</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fuzzy_matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">match_edit_distance</span> <span class="op">==</span> <span class="fl">2</span>,</span>
<span>         <span class="op">!</span><span class="va">multiple_matches</span>,</span>
<span>         <span class="va">match_similarity</span> <span class="op">&gt;</span> <span class="fl">0.9</span></span>
<span>         <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">wcvp_author_edit_distance</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">#sort by least similar authors first</span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">scientific_name</span>, <span class="va">authority</span>, <span class="va">match_type</span>,<span class="va">wcvp_name</span>, <span class="va">wcvp_authors</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 x 5</span></span>
<span><span class="co">#&gt;   scientific_name          authority                           match_type   wcvp_~1 wcvp_~2</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                    &lt;chr&gt;                               &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1 Diospyros tampolensis    H.N.Rakouth, G.E.Schatz &amp;amp; Lowry Fuzzy (edit~ Diospy~ H.Perr~</span></span>
<span><span class="co">#&gt; 2 Diospyros crassifolia    A.G.Linan, G.E.Schatz &amp;amp; Lowry   Fuzzy (edit~ Diospy~ D.Don  </span></span>
<span><span class="co">#&gt; 3 Diospyros nitidifolia    A.G.Linan, G.E.Schatz &amp;amp; Lowry   Fuzzy (edit~ Diospy~ Elmer  </span></span>
<span><span class="co">#&gt; 4 Garcinia eugeniaefolia   Wall                                Fuzzy (phon~ Garcin~ (Chois~</span></span>
<span><span class="co">#&gt; 5 Hebepetalum humiriifolia (Planch.) Benth.                    Fuzzy (edit~ Hebepe~ (Planc~</span></span>
<span><span class="co">#&gt; 6 Diospyros ambanjensis    G.E.Schatz &amp;amp; Lowry              Fuzzy (edit~ Diospy~ Gürke  </span></span>
<span><span class="co">#&gt; # ... with abbreviated variable names 1: wcvp_name, 2: wcvp_authors</span></span></code></pre></div>
<p>Hmm, clearly not!</p>
<p>If we really wanted to continue algorithmically, we could take a
random sample of 100 names and test out how accurate various rules are -
for an example using similarity, see the Supporting Information in <a href="https://doi.org/10.1002/ppp3.10146" class="external-link">Nic Lughadha et
al. (2020)</a>.</p>
<p>However, at this point, a quick glance at each name is going to give
the most accurate result and be faster.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">write_csv</span><span class="op">(</span><span class="va">fuzzy_matches</span>, <span class="st">"redlist-fuzzy-tocheck.csv"</span><span class="op">)</span></span></code></pre></div>
<p>It took under an hour to eyeball these in Excel; I marked good
matches with a 1 in the <code>keep</code> column, and bad matches with a
0. Then, I deleted all the match data except <code>match_type</code> and
<code>multiple_matches</code> for the bad matches, and added a new
column <code>resolved_match_type</code>. I left this blank for the good
matches, and filled it with “Fuzzy match rejected” for the bad
matches.</p>
<p>Now, we read that file back in.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fuzzy_checked</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">read_csv</span><span class="op">(</span><span class="st">"../../inst/extdata/redlist-fuzzy-checked.csv"</span>,</span>
<span>           show_col_types<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">keep</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>resolved_match_type<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">resolved_match_type</span><span class="op">)</span>,</span>
<span>                                    <span class="va">resolved_match_type</span>,</span>
<span>                                    <span class="va">match_type</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">checked_matches</span> <span class="op">&lt;-</span> <span class="va">matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="fu">str_detect</span><span class="op">(</span><span class="va">match_type</span>, <span class="st">"Fuzzy"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span><span class="va">fuzzy_checked</span><span class="op">)</span></span></code></pre></div>
<p>So far we’ve kept the same number of rows - we don’t want to get rid
of the bad matches (yet).</p>
</div>
<div class="section level3">
<h3 id="multiple-matches">Multiple matches<a class="anchor" aria-label="anchor" href="#multiple-matches"></a>
</h3>
<p>Now we need to deal with the multiple matches. Again, we can use some
rules to automatically resolve these:</p>
<ol style="list-style-type: decimal">
<li>Filter matches using author information. If one or more matches has
the same author string, we keep them.</li>
<li>If one (and only one) of the matches is Accepted, we keep that
one.</li>
<li>If one (and only one) of the matches is a Synonym (as opposed to
Invalid, Illegitimate, etc), we keep that one.</li>
</ol>
<p>We’ll write these rules into a function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># resolve multiple matches function ####</span></span>
<span><span class="va">resolve_multi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># some fuzzy matches are rejected from the previous section</span></span>
<span>  <span class="va">valid_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">df</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">match_similarity</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">valid_matches</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">matching_authors</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">valid_matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">wcvp_author_edit_distance</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">|</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">wcvp_author_edit_distance</span> <span class="op">==</span> <span class="fl">0</span>,</span>
<span>                                                  na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">matching_authors</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">matching_authors</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">accepted_names</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">matching_authors</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">wcvp_status</span> <span class="op">==</span> <span class="st">"Accepted"</span> <span class="op">|</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">wcvp_status</span> <span class="op">==</span> <span class="st">"Accepted"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">accepted_names</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">accepted_names</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">synonym_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Synonym"</span>, <span class="st">"Orthographic"</span>, <span class="st">"Artificial Hybrid"</span>, <span class="st">"Unplaced"</span><span class="op">)</span></span>
<span>  <span class="va">synonyms</span> <span class="op">&lt;-</span></span>
<span>    <span class="va">accepted_names</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">wcvp_status</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">synonym_codes</span> <span class="op">|</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">wcvp_status</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">synonym_codes</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">synonyms</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>  <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">synonyms</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">n_matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">synonyms</span><span class="op">$</span><span class="va">wcvp_accepted_id</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">synonyms</span><span class="op">)</span></span>
<span>  <span class="va">final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">synonyms</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">n_matches</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">final</span> <span class="op">&lt;-</span></span>
<span>      <span class="va">final</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu">mutate</span><span class="op">(</span></span>
<span>        <span class="fu">across</span><span class="op">(</span><span class="va">wcvp_id</span><span class="op">:</span><span class="va">resolved_match_type</span> <span class="op">&amp;</span> <span class="fu">where</span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="op">~</span><span class="cn">NA_real_</span><span class="op">)</span>,</span>
<span>        <span class="fu">across</span><span class="op">(</span><span class="va">wcvp_id</span><span class="op">:</span><span class="va">resolved_match_type</span> <span class="op">&amp;</span> <span class="fu">where</span><span class="op">(</span><span class="va">is.character</span><span class="op">)</span>, <span class="op">~</span><span class="cn">NA_character_</span><span class="op">)</span>,</span>
<span>        resolved_match_type<span class="op">=</span><span class="st">"Could not resolve multiple matches"</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">final</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we go through each name that has multiple matches and apply these
rules.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">auto_resolved</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">checked_matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">nest_by</span><span class="op">(</span><span class="va">scientific_name</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">resolve_multi</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">unnest</span><span class="op">(</span>col<span class="op">=</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">auto_resolved</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">auto_resolved</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>resolved_match_type<span class="op">=</span><span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">resolved_match_type</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">match_type</span><span class="op">)</span> <span class="op">~</span> <span class="st">"No match found"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">resolved_match_type</span><span class="op">)</span> <span class="op">~</span> <span class="va">match_type</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">resolved_match_type</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>How did our automatic resolution do?</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">count</span><span class="op">(</span><span class="va">auto_resolved</span>, <span class="va">resolved_match_type</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 x 2</span></span>
<span><span class="co">#&gt;   resolved_match_type                    n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                              &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 Could not resolve multiple matches     6</span></span>
<span><span class="co">#&gt; 2 Exact (with author)                43266</span></span>
<span><span class="co">#&gt; 3 Exact (without author)             16893</span></span>
<span><span class="co">#&gt; 4 Fuzzy (edit distance)                323</span></span>
<span><span class="co">#&gt; 5 Fuzzy (phonetic)                     350</span></span>
<span><span class="co">#&gt; 6 Fuzzy match rejected                  90</span></span></code></pre></div>
<p>Hmm, still ~90 names (less than 1% of the original dataset) that we
couldn’t find a match for. For most datasets, this is an acceptable
loss, but this particular data will be used for several papers, so it’s
worth going through more carefully.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">auto_resolved</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">resolved_match_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"No match found"</span>,<span class="st">"Fuzzy match rejected"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">write_csv</span><span class="op">(</span><span class="st">"redlist_tomanuallymatch.csv"</span><span class="op">)</span></span></code></pre></div>
<p>Here’s one we prepared earlier.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">manually_resolved</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"../../inst/extdata/redlist-manually-matched.csv"</span>,</span>
<span>                              show_col_types<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">count</span><span class="op">(</span><span class="va">manually_resolved</span>, <span class="va">resolved_match_type</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 x 2</span></span>
<span><span class="co">#&gt;   resolved_match_type         n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                   &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 Manually matched           14</span></span>
<span><span class="co">#&gt; 2 New/undescribed species    55</span></span>
<span><span class="co">#&gt; 3 No valid match found       21</span></span></code></pre></div>
<p>In this example, many of the unmatched names are new species that
have not been added to the WCVP (sometimes listed as
e.g. <em>Heptapleurum</em> sp.), making it quicker than searching every
name individually. Still, it’s a time consuming process with a
relatively small success rate (here, we found names for 95), so it will
not be applicable to all (or even most) name-matching workflows.</p>
<p>We need to re-run matching on the manually matched names, to get the
rest of the info.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">manually_resolved</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">manually_resolved</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/wcvp_match_names.html">wcvp_match_names</a></span><span class="op">(</span>name_col <span class="op">=</span> <span class="st">"manually_entered_name"</span>, fuzzy<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- Matching names to WCVP -----------------------------------------------------------------</span></span>
<span><span class="co">#&gt; i Using the `manually_entered_name` column</span></span>
<span><span class="co">#&gt; ! No author information supplied - matching on taxon name only</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- Exact matching  names --</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; v Found 13 of  names</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- Matching complete! --</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; v Matched 13 of 15 names</span></span>
<span><span class="co">#&gt; i Exact (without author): 13</span></span>
<span><span class="co">#&gt; i No match found: 2</span></span>
<span><span class="co">#&gt; ! Names with multiple matches: 0</span></span></code></pre></div>
<p>This has produced a couple of multiple matches again. We could have
avoided this by entering the WCVP ID that we wanted rather than the
name. But in this case, it only affects a couple of records. Looking at
these, the extra names are illegitimate, so we can just quickly filter
these out.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">manually_resolved</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">manually_resolved</span>, <span class="va">wcvp_status</span> <span class="op">!=</span> <span class="st">"Illegitimate"</span><span class="op">)</span></span></code></pre></div>
<p>And now we’ll insert them back into our match results and remove
anything that remains unmatched.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resolved_matches</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">manually_resolved</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">manually_entered_name</span>, <span class="va">Notes</span>, <span class="va">match_type</span>, <span class="va">multiple_matches</span>,</span>
<span>            <span class="va">match_similarity</span>, <span class="va">match_edit_distance</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>match_type<span class="op">=</span><span class="va">original_match_type</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>    <span class="va">auto_resolved</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="va">scientific_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">manually_resolved</span><span class="op">$</span><span class="va">scientific_name</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Finally, we’ll take a look at a summary of our name resolution in a
nicely formatted table.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resolved_matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">resolved_match_type</span>, sort<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/gt.html" class="external-link">gt</a></span><span class="op">(</span>rowname_col <span class="op">=</span> <span class="st">"resolved_match_type"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_options.html" class="external-link">tab_options</a></span><span class="op">(</span>table_body.hlines.color <span class="op">=</span> <span class="st">"transparent"</span>,</span>
<span>              column_labels.hidden <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/summary_rows.html" class="external-link">summary_rows</a></span><span class="op">(</span></span>
<span>    columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>    fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Total <span class="op">=</span><span class="st">"sum"</span><span class="op">)</span>,</span>
<span>    formatter <span class="op">=</span> <span class="va">fmt_integer</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_style.html" class="external-link">tab_style</a></span><span class="op">(</span></span>
<span>    style <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://gt.rstudio.com/reference/cell_text.html" class="external-link">cell_text</a></span><span class="op">(</span>align <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    locations <span class="op">=</span> <span class="fu"><a href="https://gt.rstudio.com/reference/cells_stub.html" class="external-link">cells_stub</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/tab_header.html" class="external-link">tab_header</a></span><span class="op">(</span><span class="st">"Match summary"</span>, <span class="st">"(after resolution of fuzzy and multiple matches)"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://gt.rstudio.com/reference/opt_align_table_header.html" class="external-link">opt_align_table_header</a></span><span class="op">(</span>align <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span></span></code></pre></div>
<div id="ykzcnvzeht" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#ykzcnvzeht .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ykzcnvzeht .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ykzcnvzeht .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ykzcnvzeht .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ykzcnvzeht .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ykzcnvzeht .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ykzcnvzeht .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ykzcnvzeht .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ykzcnvzeht .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ykzcnvzeht .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ykzcnvzeht .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ykzcnvzeht .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#ykzcnvzeht .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ykzcnvzeht .gt_from_md > :first-child {
  margin-top: 0;
}

#ykzcnvzeht .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ykzcnvzeht .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: rgba(255, 255, 255, 0);
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ykzcnvzeht .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#ykzcnvzeht .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#ykzcnvzeht .gt_row_group_first td {
  border-top-width: 2px;
}

#ykzcnvzeht .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ykzcnvzeht .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#ykzcnvzeht .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#ykzcnvzeht .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ykzcnvzeht .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ykzcnvzeht .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ykzcnvzeht .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ykzcnvzeht .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ykzcnvzeht .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ykzcnvzeht .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ykzcnvzeht .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ykzcnvzeht .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ykzcnvzeht .gt_left {
  text-align: left;
}

#ykzcnvzeht .gt_center {
  text-align: center;
}

#ykzcnvzeht .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ykzcnvzeht .gt_font_normal {
  font-weight: normal;
}

#ykzcnvzeht .gt_font_bold {
  font-weight: bold;
}

#ykzcnvzeht .gt_font_italic {
  font-style: italic;
}

#ykzcnvzeht .gt_super {
  font-size: 65%;
}

#ykzcnvzeht .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

#ykzcnvzeht .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#ykzcnvzeht .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#ykzcnvzeht .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

#ykzcnvzeht .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

#ykzcnvzeht .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="table gt_table">
<thead class="gt_header">
<tr>
<th colspan="2" class="gt_heading gt_title gt_font_normal" style>Match summary</th>
    </tr>
<tr>
<th colspan="2" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style>(after resolution of fuzzy and multiple matches)</th>
    </tr>
</thead>
<tbody class="gt_table_body">
<tr>
<td class="gt_row gt_right gt_stub" style="text-align: left;">Exact (with author)</td>
<td class="gt_row gt_right">43266</td>
</tr>
<tr>
<td class="gt_row gt_right gt_stub" style="text-align: left;">Exact (without author)</td>
<td class="gt_row gt_right">16893</td>
</tr>
<tr>
<td class="gt_row gt_right gt_stub" style="text-align: left;">Fuzzy (phonetic)</td>
<td class="gt_row gt_right">350</td>
</tr>
<tr>
<td class="gt_row gt_right gt_stub" style="text-align: left;">Fuzzy (edit distance)</td>
<td class="gt_row gt_right">323</td>
</tr>
<tr>
<td class="gt_row gt_right gt_stub" style="text-align: left;">Fuzzy match rejected</td>
<td class="gt_row gt_right">77</td>
</tr>
<tr>
<td class="gt_row gt_right gt_stub" style="text-align: left;">Manually matched</td>
<td class="gt_row gt_right">13</td>
</tr>
<tr>
<td class="gt_row gt_right gt_stub" style="text-align: left;">Could not resolve multiple matches</td>
<td class="gt_row gt_right">6</td>
</tr>
<tr>
<td class="gt_row gt_right gt_stub gt_grand_summary_row gt_first_grand_summary_row gt_last_summary_row">Total</td>
<td class="gt_row gt_right gt_grand_summary_row gt_first_grand_summary_row gt_last_summary_row">60,928</td>
</tr>
</tbody>
</table>
</div>
<p>Great!</p>
</div>
<div class="section level3">
<h3 id="linking-assessments-to-accepted-names">Linking assessments to accepted names<a class="anchor" aria-label="anchor" href="#linking-assessments-to-accepted-names"></a>
</h3>
<p>There is one last step before we’re finished resolving our name
matches - linking each Red List assessment to an accepted species name.
This is where things get a little tricky - for synonyms, we need to
consider how the name change affects the assessment. Specifically, we
can only apply the new name to the assessment if the taxonomic concept
has been preserved.</p>
<p><img src="synonymy-diagram.png" style="width:50.0%"></p>
<p>Luckily, we can use the <code>homotypic_synonym</code> column of the
WCVP to easily filter our matches.</p>
<p>We’ll add the full WCVP to our data, using
<code>wcvp_accepted_id</code> to join with <code>plant_name_id</code>.
We then only want to flag names that matched to accepted species or
matched to homotypic synonyms that link to accepted species.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># a for accepted</span></span>
<span><span class="va">accepted_matches</span> <span class="op">&lt;-</span> <span class="va">resolved_matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="fu">rWCVPdata</span><span class="fu">::</span><span class="va"><a href="https://matildabrown.github.io/rWCVPdata/reference/wcvp_names.html">wcvp_names</a></span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"wcvp_accepted_id"</span><span class="op">=</span><span class="st">"plant_name_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>keep<span class="op">=</span><span class="fu">case_when</span><span class="op">(</span></span>
<span>    <span class="va">taxon_status</span> <span class="op">==</span> <span class="st">"Accepted"</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">wcvp_status</span> <span class="op">!=</span> <span class="st">"Synonym"</span> <span class="op">|</span> <span class="va">wcvp_homotypic</span><span class="op">)</span> <span class="op">~</span></span>
<span>      <span class="st">"Matched to an accepted name"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Not matched to an accepted name"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">count</span><span class="op">(</span><span class="va">accepted_matches</span>, <span class="va">keep</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 x 2</span></span>
<span><span class="co">#&gt;   keep                                n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                           &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 Matched to an accepted name     59084</span></span>
<span><span class="co">#&gt; 2 Not matched to an accepted name  1844</span></span></code></pre></div>
<p>Still the vast majority!</p>
</div>
</div>
<div class="section level2">
<h2 id="visualising-the-matching-process">Visualising the matching process<a class="anchor" aria-label="anchor" href="#visualising-the-matching-process"></a>
</h2>
<p>One thing we might want to do, to check how the matching process
went, is visualise the proportion of names going through each type of
matching. An alluvial diagram offers one way of doing this.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step1_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Exact (with author)"</span><span class="op">=</span><span class="st">"Exact"</span>,</span>
<span>                 <span class="st">"Exact (without author)"</span><span class="op">=</span><span class="st">"Exact"</span>,</span>
<span>                 <span class="st">"Fuzzy (edit distance)"</span><span class="op">=</span><span class="st">"Fuzzy"</span>,</span>
<span>                 <span class="st">"Fuzzy (phonetic)"</span><span class="op">=</span><span class="st">"Fuzzy"</span><span class="op">)</span></span>
<span><span class="va">step2_codes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Exact (without author)"</span><span class="op">=</span><span class="st">"\U2713"</span>,</span>
<span>                 <span class="st">"Exact (with author)"</span><span class="op">=</span><span class="st">"\U2713"</span>,</span>
<span>                 <span class="st">"Fuzzy (edit distance)"</span><span class="op">=</span><span class="st">"\U2713"</span>,</span>
<span>                 <span class="st">"Fuzzy (phonetic)"</span><span class="op">=</span><span class="st">"\U2713"</span>,</span>
<span>                 <span class="st">"Could not resolve multiple matches"</span><span class="op">=</span><span class="st">"\U2716"</span>,</span>
<span>                 <span class="st">"Fuzzy match rejected"</span><span class="op">=</span><span class="st">"\U2716"</span>,</span>
<span>                 <span class="st">"No match found"</span><span class="op">=</span><span class="st">"\U2716"</span><span class="op">)</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">accepted_matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>step0<span class="op">=</span><span class="st">"Input"</span>,</span>
<span>         step1<span class="op">=</span><span class="fu">recode</span><span class="op">(</span><span class="va">match_type</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span> <span class="va">step1_codes</span><span class="op">)</span>,</span>
<span>         step2<span class="op">=</span><span class="fu">recode</span><span class="op">(</span><span class="va">resolved_match_type</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span> <span class="va">step2_codes</span><span class="op">)</span>,</span>
<span>         step3<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">keep</span> <span class="op">==</span> <span class="st">"Matched to an accepted name"</span>, <span class="st">"\U2713"</span>, <span class="st">"\U2716"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">replace_na</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>multiple_matches<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>scenario<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">step1</span>, <span class="va">step2</span>, <span class="va">step3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">step0</span>, <span class="va">step1</span>, <span class="va">step2</span>, <span class="va">step3</span>, <span class="va">scenario</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>colour_key<span class="op">=</span><span class="va">step3</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">to_lodes_form</span><span class="op">(</span>axes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span>, id<span class="op">=</span><span class="st">"scenario"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">x</span>, <span class="va">stratum</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu">row_number</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">stratum</span><span class="op">)</span>, <span class="cn">NA_character_</span><span class="op">)</span>,</span>
<span>         total<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">total</span> <span class="op">&lt;</span> <span class="fl">1500</span>, <span class="cn">NA_character_</span>, <span class="va">label</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span>mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">n</span>, stratum<span class="op">=</span><span class="va">stratum</span>, alluvium<span class="op">=</span><span class="va">scenario</span>, fill<span class="op">=</span><span class="va">colour_key</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette<span class="op">=</span><span class="st">"Set2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_flow</span><span class="op">(</span>stat<span class="op">=</span><span class="st">"alluvium"</span>, lode.guidance<span class="op">=</span><span class="st">"frontback"</span>, color<span class="op">=</span><span class="st">"darkgrey"</span>,</span>
<span>            aes.flow<span class="op">=</span><span class="st">"forward"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stratum</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span>mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span>label<span class="op">=</span><span class="va">label</span><span class="op">)</span>, vjust<span class="op">=</span><span class="fl">0.75</span>, size<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">61371</span> <span class="op">*</span> <span class="fl">1.03</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>           label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Initial"</span>, <span class="st">"Resolved"</span>, <span class="st">"Accepted"</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/unnamed-chunk-3-1.png"></p>
<p>Clearly, the vast majority of the names have exact matches (with and
without author string) that needed no resolution. If we exclude them,
effectively zooming in on the lower part of that figure, we can see more
detail on the less straightforward matches.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">accepted_matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>step1<span class="op">=</span><span class="fu">str_replace</span><span class="op">(</span><span class="va">match_type</span>, <span class="st">"\\("</span>, <span class="st">"\n\\("</span><span class="op">)</span>,</span>
<span>         step2<span class="op">=</span><span class="fu">str_replace</span><span class="op">(</span><span class="va">resolved_match_type</span>, <span class="st">"\\("</span>, <span class="st">"\n\\("</span><span class="op">)</span>,</span>
<span>         step3<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">keep</span> <span class="op">==</span> <span class="st">"Matched to an accepted name"</span>, <span class="st">"\U2713"</span>, <span class="st">"\U2716"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>scenario<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">step1</span>, <span class="va">step2</span>, <span class="va">step3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">step1</span>, <span class="va">step2</span>, <span class="va">step3</span>, <span class="va">scenario</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>colour_key<span class="op">=</span><span class="va">step3</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">to_lodes_form</span><span class="op">(</span>axes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span>, id<span class="op">=</span><span class="st">"scenario"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>label1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">stratum</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"\U2713"</span>, <span class="st">"\U2716"</span><span class="op">)</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">stratum</span><span class="op">)</span>, <span class="cn">NA_character_</span><span class="op">)</span>,</span>
<span>         label2<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="op">!</span> <span class="va">stratum</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"\U2713"</span>, <span class="st">"\U2716"</span><span class="op">)</span>,</span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">stratum</span><span class="op">)</span>, <span class="cn">NA_character_</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">#filter out the big categories</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&lt;</span> <span class="fl">4000</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">n</span>, stratum<span class="op">=</span><span class="va">stratum</span>, alluvium<span class="op">=</span><span class="va">scenario</span>, fill<span class="op">=</span><span class="va">colour_key</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_flow</span><span class="op">(</span>stat<span class="op">=</span><span class="st">"alluvium"</span>, lode.guidance<span class="op">=</span><span class="st">"frontback"</span>,</span>
<span>            color<span class="op">=</span><span class="st">"darkgray"</span>, aes.flow<span class="op">=</span><span class="st">"forward"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_stratum</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span>mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span>label<span class="op">=</span><span class="va">label1</span><span class="op">)</span>, stat<span class="op">=</span><span class="st">"stratum"</span>, size<span class="op">=</span><span class="fl">8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span>mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span>label<span class="op">=</span><span class="va">label2</span><span class="op">)</span>, stat <span class="op">=</span> <span class="st">"stratum"</span>, size<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, y<span class="op">=</span><span class="fl">2950</span>, label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Initial"</span>, <span class="st">"Resolved"</span>, <span class="st">"Accepted"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">3.4</span>, y<span class="op">=</span><span class="fl">1000</span>,</span>
<span>           label<span class="op">=</span><span class="st">"e.g. heterotypic \nsynonyms, \nunplaced names"</span>, size<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/unnamed-chunk-4-1.png"></p>
</div>
<div class="section level2">
<h2 id="getting-a-final-dataset">Getting a final dataset<a class="anchor" aria-label="anchor" href="#getting-a-final-dataset"></a>
</h2>
<p>Finally, we want to turn our large data frame into something more
manageable that we can use for downstream analyses, by filtering out all
of the unsuccessful matches and reducing the number of columns (plus
renaming them to be more intuitive).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_matches</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">accepted_matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">keep</span> <span class="op">==</span> <span class="st">"Matched to an accepted name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">scientific_name</span>, <span class="va">authority</span>, <span class="va">category</span>,</span>
<span>         match_name<span class="op">=</span><span class="va">wcvp_name</span>, match_status<span class="op">=</span><span class="va">wcvp_status</span>,</span>
<span>         accepted_plant_name_id<span class="op">=</span><span class="va">wcvp_accepted_id</span>, <span class="va">ipni_id</span>,</span>
<span>         accepted_taxon_name<span class="op">=</span><span class="va">taxon_name</span>, accepted_taxon_authors<span class="op">=</span><span class="va">taxon_authors</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">glimpse</span><span class="op">(</span><span class="va">final_matches</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 59,084</span></span>
<span><span class="co">#&gt; Columns: 9</span></span>
<span><span class="co">#&gt; $ scientific_name        &lt;chr&gt; "Actinodaphne leiantha", "Camellia dongnaiensis", "Carex c~</span></span>
<span><span class="co">#&gt; $ authority              &lt;chr&gt; "Hook.f.", "Orel", "Nees", "Lapeyr.", "(Speg.) D.R.Hunt", ~</span></span>
<span><span class="co">#&gt; $ category               &lt;chr&gt; "DD", "CR", "LC", "LC", "LC", "LC", "LC", "NT", "DD", "DD"~</span></span>
<span><span class="co">#&gt; $ match_name             &lt;chr&gt; "Actinodaphne leiophylla", "Camellia dongnaicensis", "Care~</span></span>
<span><span class="co">#&gt; $ match_status           &lt;chr&gt; "Accepted", "Accepted", "Accepted", "Accepted", "Accepted"~</span></span>
<span><span class="co">#&gt; $ accepted_plant_name_id &lt;dbl&gt; 2620909, 2694538, 225431, 228432, 2783444, 73175, 111885, ~</span></span>
<span><span class="co">#&gt; $ ipni_id                &lt;chr&gt; "462276-1", "60443091-2", "298997-1", "300830-1", "963225-~</span></span>
<span><span class="co">#&gt; $ accepted_taxon_name    &lt;chr&gt; "Actinodaphne leiophylla", "Camellia dongnaicensis", "Care~</span></span>
<span><span class="co">#&gt; $ accepted_taxon_authors &lt;chr&gt; "(Kurz) Hook.f.", "Orel", "L.", "Lapeyr.", "(Speg.) D.R.Hu~</span></span></code></pre></div>
<p>And, just as an example of a downstream analysis, we might want to
show the number of accepted species in each Red List category.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cat_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DD"</span>, <span class="st">"LC or LR/lc"</span>, <span class="st">"NT or LR/nt"</span>, <span class="st">"LR/cd"</span>, <span class="st">"VU"</span>, <span class="st">"EN"</span>, <span class="st">"CR"</span>,</span>
<span>               <span class="st">"EW"</span>, <span class="st">"EX"</span><span class="op">)</span></span>
<span><span class="va">cat_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DD"</span><span class="op">=</span><span class="st">"#D1D1C6"</span>, <span class="st">"LC or LR/lc"</span><span class="op">=</span><span class="st">"#60C659"</span>, <span class="st">"NT or LR/nt"</span><span class="op">=</span><span class="st">"#CCE226"</span>,</span>
<span>                <span class="st">"LR/cd"</span><span class="op">=</span><span class="st">"#e4d354"</span>, <span class="st">"VU"</span><span class="op">=</span><span class="st">"#F9E814"</span>, <span class="st">"EN"</span><span class="op">=</span><span class="st">"#FC7F3F"</span>, <span class="st">"CR"</span><span class="op">=</span><span class="st">"#D81E05"</span>,</span>
<span>                <span class="st">"EW"</span><span class="op">=</span><span class="st">"#542344"</span>, <span class="st">"EX"</span><span class="op">=</span><span class="st">"#000000"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_matches</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>category<span class="op">=</span><span class="fu">recode</span><span class="op">(</span><span class="va">category</span>, <span class="st">"LC"</span><span class="op">=</span><span class="st">"LC or LR/lc"</span>, <span class="st">"LR/lc"</span><span class="op">=</span><span class="st">"LC or LR/lc"</span>,</span>
<span>                         <span class="st">"NT"</span><span class="op">=</span><span class="st">"NT or LR/nt"</span>, <span class="st">"LR/nt"</span><span class="op">=</span><span class="st">"NT or LR/nt"</span><span class="op">)</span>,</span>
<span>         category<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">category</span>, levels<span class="op">=</span><span class="va">cat_order</span>, ordered<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">category</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>p<span class="op">=</span><span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span>mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span>x<span class="op">=</span><span class="va">category</span>, y<span class="op">=</span><span class="va">n</span>, fill<span class="op">=</span><span class="va">category</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_text</span><span class="op">(</span>mapping<span class="op">=</span><span class="fu">aes</span><span class="op">(</span>label<span class="op">=</span><span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/percent_format.html" class="external-link">percent_format</a></span><span class="op">(</span>accuracy<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span>, vjust<span class="op">=</span><span class="op">-</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values<span class="op">=</span><span class="va">cat_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">guides</span><span class="op">(</span>fill<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Species"</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/plot-categories-1.png"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Matilda Brown, Barnaby Walker.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
