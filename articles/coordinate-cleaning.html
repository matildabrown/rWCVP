<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Cleaning coordinates to species' native range with rWCVP • rWCVP</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cleaning coordinates to species' native range with rWCVP">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rWCVP</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/rWCVP.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/coordinate-cleaning.html">Cleaning coordinates to species' native range with rWCVP</a></li>
    <li><a class="dropdown-item" href="../articles/custom-checklist.html">Generating custom checklists with rWCVP</a></li>
    <li><a class="dropdown-item" href="../articles/mapping-diversity.html">Mapping diversity with rWCVP</a></li>
    <li><a class="dropdown-item" href="../articles/occurrence-matrices.html">Publication-ready occurrence matrices with rWCVP</a></li>
    <li><a class="dropdown-item" href="../articles/redlist-name-matching.html">Matching names to WCVP with rWCVP</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/matildabrown/rWCVP/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Cleaning coordinates to species' native range with rWCVP</h1>
                        <h4 data-toc-skip class="author">Matilda
Brown</h4>
            
            <h4 data-toc-skip class="date">03 February, 2023</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/matildabrown/rWCVP/blob/master/vignettes/articles/coordinate-cleaning.Rmd" class="external-link"><code>vignettes/articles/coordinate-cleaning.Rmd</code></a></small>
      <div class="d-none name"><code>coordinate-cleaning.Rmd</code></div>
    </div>

    
    
<!-- GENERATED BY vignettes/articles/precompile.R -->
<p>The <a href="https://wcvp.science.kew.org" class="external-link">World Checklist of
Vascular Plants (WCVP)</a> provides coarse-scale distribution data for
all &gt; 340,000 vascular plant species known to science. This
distribution data provides information about species’ native and
introduced ranges. We can use the native range data to clean occurrence
records for species by removing potentially implausible occurrences.</p>
<p>To do this, as well as <code>rWCVP</code>, we’ll use the
<code>rgbif</code> library to download occurrence records, the
<code>tidyverse</code> library to do data manipulation, and the
<code>sf</code> library to handle the shapes of the native ranges.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/matildabrown/rWCVP" class="external-link">rWCVP</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rgbif" class="external-link">rgbif</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="cleaning-occurrence-records-for-a-single-species">Cleaning occurrence records for a single species<a class="anchor" aria-label="anchor" href="#cleaning-occurrence-records-for-a-single-species"></a>
</h2>
<p>In this tutorial, we’ll use <em>Callitris rhomboidea</em> (a lovely
Australian conifer) as an example.</p>
<div class="section level3">
<h3 id="downloading-occurrence-records">Downloading occurrence records<a class="anchor" aria-label="anchor" href="#downloading-occurrence-records"></a>
</h3>
<p>The first step is to get the occurrences records from somewhere.
We’ll use <code>rgbif</code> to get these from GBIF.</p>
<p>We’ve limited the number of occurrences to 1000 here, so it doesn’t
take too long to download. And we’ve requested to only get records with
coordinates that don’t have any issues automatically flagged by
GBIF.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gbif_response</span> <span class="op">&lt;-</span> <span class="fu">occ_data</span><span class="op">(</span>scientificName<span class="op">=</span><span class="st">"Callitris rhomboidea"</span>, limit<span class="op">=</span><span class="fl">1000</span>,</span>
<span>                          hasCoordinate<span class="op">=</span><span class="cn">TRUE</span>, hasGeospatialIssue<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="st">"of"</span>, <span class="va">gbif_response</span><span class="op">$</span><span class="va">meta</span><span class="op">$</span><span class="va">count</span>, <span class="st">"records downloaded."</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1000 of 3498 records downloaded."</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="preparing-the-occurrences">Preparing the occurrences<a class="anchor" aria-label="anchor" href="#preparing-the-occurrences"></a>
</h3>
<p>Before we remote the non-native occurrences from our download, we
need to get the data in the right format.</p>
<p>Removing the non-native occurrences can be quite computationally
expensive, if you have a large number of occurrences and a species that
is native to a large number of regions. So you probably want to do any
cleaning steps, like removing records from the sea or that are at known
institution locations, before filtering by the native range.</p>
<p>For now, because we don’t have too many points, we won’t do anymore
cleaning. But we do make sure we convert our data frame of records to a
spatial data frame to be able to filter the points using the shapes for
our species’ native range.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occs</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">gbif_response</span><span class="op">$</span><span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">scientificName</span>, <span class="va">decimalLatitude</span>, <span class="va">decimalLongitude</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><em>Note</em> - if you’re using your own data frame of occurrences,
rather than one downloaded from GBIF, you’ll still need to convert it to
a spatial data frame like we’ve done above and set the appropriate
coordinate system. We’ve used EPSG 4326 here because it’s the default
one for coordinates in degrees longitude and latitude.</p>
</div>
<div class="section level3">
<h3 id="getting-the-native-range">Getting the native range<a class="anchor" aria-label="anchor" href="#getting-the-native-range"></a>
</h3>
<p>Now we can use <code>rWCVP</code> to download the native distribution
of our species.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">native_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wcvp_distribution.html">wcvp_distribution</a></span><span class="op">(</span><span class="st">"Callitris rhomboidea"</span>, taxon_rank<span class="op">=</span><span class="st">"species"</span>,</span>
<span>                                introduced<span class="op">=</span><span class="cn">FALSE</span>, extinct<span class="op">=</span><span class="cn">FALSE</span>, </span>
<span>                                location_doubtful<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>And take a look at it.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wcvp_distribution_map.html">wcvp_distribution_map</a></span><span class="op">(</span><span class="va">native_range</span>, crop_map<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">theme</span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"none"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/plot-native-1.png"></p>
<p>And how do our occurrence records map onto the range?</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">+</span> <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">occs</span>, fill<span class="op">=</span><span class="st">"#6e6ad9"</span>,col<span class="op">=</span><span class="st">"black"</span>, shape<span class="op">=</span><span class="fl">21</span><span class="op">)</span> </span></code></pre></div>
<p><img src="figure/plot-occ-1.png"></p>
<p>Yikes, some very rogue points!</p>
</div>
<div class="section level3">
<h3 id="removing-non-native-occurrences">Removing non-native occurrences<a class="anchor" aria-label="anchor" href="#removing-non-native-occurrences"></a>
</h3>
<p>Now let’s get rid of those rogue points.</p>
<p>One way to do this is to check which points fall within the native
range polygons, getting a TRUE/FALSE value for each. We can use the
<code>st_intersects</code> function from <code>sf</code> to do this. As
we have four native range polygons, we would get four values for each
point rather than just one, so we also merge the native range polygons
together using <code>st_union</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occs</span><span class="op">$</span><span class="va">native</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_intersects</a></span><span class="op">(</span><span class="va">occs</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="va">native_range</span><span class="op">)</span>, sparse<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<p>Highlighting them on the map gives an idea of which points are
erroneous.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">occs</span>,</span>
<span>          fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>,<span class="st">"#72994c"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">occs</span><span class="op">$</span><span class="va">native</span><span class="op">)</span><span class="op">]</span>,</span>
<span>          col<span class="op">=</span><span class="st">"black"</span>, </span>
<span>          shape<span class="op">=</span><span class="fl">21</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/plot-native-occ-1.png"></p>
<p>Some of these are obviously bad (very far from the native range), but
some are quite close.</p>
<p>Let’s have a closer look at the ones that are near the native range
polygons:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">native_range</span><span class="op">)</span> <span class="co">#getting a sensible bounding box</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">occs</span>, </span>
<span>          fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>,<span class="st">"#72994c"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">occs</span><span class="op">$</span><span class="va">native</span><span class="op">)</span><span class="op">]</span>,</span>
<span>          col<span class="op">=</span><span class="st">"black"</span>, </span>
<span>          shape<span class="op">=</span><span class="fl">21</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span>xlim<span class="op">=</span><span class="va">lims</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span>, ylim<span class="op">=</span><span class="va">lims</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/plot-native-occ-zoom-1.png"></p>
<p>Ah, they are in the water! Some are quite obviously off the coast but
there are a few that are quite close. This might be a problem with the
resolution of the WGSRPD shape files we’re using - a higher resolution
might reveal the points are actually within the native range.</p>
<p>We can try adding a buffer so that we are not cleaning too
enthusiastically.</p>
<p>The coordinates for the shape file are in degrees, so a 1 km buffer
is approximately 0.009 degrees latitude (and longitude at the equator).
For high latitudes, a buffer of 0.009 degrees is going to be
significantly more than 1 km, so you might want to change the buffer
depending on the location and span of your data.</p>
<p>Let’s see which of our occurrences fall within ~1 km of the native
range. For clarity, we’ve removed the points that are within the native
range and are just plotting the points that are within the buffer
(yellow) and those that are outside the buffer (red).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">buffered_dist</span> <span class="op">&lt;-</span> <span class="va">native_range</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="fl">0.009</span><span class="op">)</span></span>
<span></span>
<span><span class="va">occs</span><span class="op">$</span><span class="va">native_buffer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_intersects</a></span><span class="op">(</span><span class="va">occs</span>, <span class="va">buffered_dist</span>, sparse<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># filter out the points that are in the native range</span></span>
<span><span class="va">suspect_occs</span> <span class="op">&lt;-</span> <span class="va">occs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="va">native</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">buffered_dist</span>, fill<span class="op">=</span><span class="st">"transparent"</span>, col<span class="op">=</span><span class="st">"gold"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">suspect_occs</span>, </span>
<span>          fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>,<span class="st">"gold"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">suspect_occs</span><span class="op">$</span><span class="va">native_buffer</span><span class="op">)</span><span class="op">]</span>,</span>
<span>          col<span class="op">=</span><span class="st">"black"</span>, </span>
<span>          shape<span class="op">=</span><span class="fl">21</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu">coord_sf</span><span class="op">(</span>xlim<span class="op">=</span><span class="va">lims</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span>, ylim<span class="op">=</span><span class="va">lims</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/buffer-range-1.png"> An appropriate buffer width
might be wider or narrower, depending on downstream analyses, but
visualisation can help to sense-check the buffer before discarding
points.</p>
<p>Now, we can discard occurrences that are &gt;1 km (approximately)
outside of the native range.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occs_filtered</span> <span class="op">&lt;-</span> <span class="va">occs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">native_buffer</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#filtered occurrences plotted</span></span>
<span><span class="va">p</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data<span class="op">=</span><span class="va">occs_filtered</span>, fill<span class="op">=</span><span class="st">"#6e6ad9"</span>,col<span class="op">=</span><span class="st">"black"</span>, shape<span class="op">=</span><span class="fl">21</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/final-filter-1.png"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matilda Brown, Barnaby Walker.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
